#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>
#include <signal.h>

#include "crc.h"

crc get_app_checksum(const char* path, const char* name);
int get_app_pid(const char* name);
int rename_app(const char* path, const char* current_name, const char* new_name, int retries);
int write_app(const char* path, const char* name, const char* binary, size_t size);

int main(void) {

unsigned char bin[] = {127,69,76,70,1,1,1,0,0,0,0,0,0,0,0,0,2,0,3,0,1,0,0,0,0,131,4,8,52,0,0,0,92,17,0,0,0,0,0,0,52,0,32,0,8,0,40,0,29,0,26,0,6,0,0,0,52,0,0,0,52,128,4,8,52,128,4,8,0,1,0,0,0,1,0,0,5,0,0,0,4,0,0,0,3,0,0,0,52,1,0,0,52,129,4,8,52,129,4,8,19,0,0,0,19,0,0,0,4,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,128,4,8,0,128,4,8,188,4,0,0,188,4,0,0,5,0,0,0,0,16,0,0,1,0,0,0,20,15,0,0,20,159,4,8,20,159,4,8,0,1,0,0,8,1,0,0,6,0,0,0,0,16,0,0,2,0,0,0,40,15,0,0,40,159,4,8,40,159,4,8,200,0,0,0,200,0,0,0,6,0,0,0,4,0,0,0,4,0,0,0,72,1,0,0,72,129,4,8,72,129,4,8,68,0,0,0,68,0,0,0,4,0,0,0,4,0,0,0,81,229,116,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,0,4,0,0,0,82,229,116,100,20,15,0,0,20,159,4,8,20,159,4,8,236,0,0,0,236,0,0,0,4,0,0,0,1,0,0,0,47,108,105,98,47,108,100,45,108,105,110,117,120,46,115,111,46,50,0,0,4,0,0,0,16,0,0,0,1,0,0,0,71,78,85,0,0,0,0,0,2,0,0,0,6,0,0,0,15,0,0,0,4,0,0,0,20,0,0,0,3,0,0,0,71,78,85,0,221,11,111,206,37,79,114,55,219,224,99,38,221,165,132,213,235,149,178,147,2,0,0,0,4,0,0,0,1,0,0,0,5,0,0,0,0,32,0,32,0,0,0,0,4,0,0,0,173,75,227,192,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,32,0,0,0,46,0,0,0,0,0,0,0,0,0,0,0,18,0,0,0,41,0,0,0,0,0,0,0,0,0,0,0,18,0,0,0,26,0,0,0,156,132,4,8,4,0,0,0,17,0,15,0,0,95,95,103,109,111,110,95,115,116,97,114,116,95,95,0,108,105,98,99,46,115,111,46,54,0,95,73,79,95,115,116,100,105,110,95,117,115,101,100,0,112,117,116,115,0,95,95,108,105,98,99,95,115,116,97,114,116,95,109,97,105,110,0,71,76,73,66,67,95,50,46,48,0,0,0,0,0,2,0,2,0,1,0,1,0,1,0,16,0,0,0,16,0,0,0,0,0,0,0,16,105,105,13,0,0,2,0,64,0,0,0,0,0,0,0,240,159,4,8,6,1,0,0,0,160,4,8,7,1,0,0,4,160,4,8,7,2,0,0,8,160,4,8,7,3,0,0,85,137,229,83,131,236,4,232,0,0,0,0,91,129,195,88,29,0,0,139,147,252,255,255,255,133,210,116,5,232,30,0,0,0,232,217,0,0,0,232,148,1,0,0,88,91,201,195,255,53,248,159,4,8,255,37,252,159,4,8,0,0,0,0,255,37,0,160,4,8,104,0,0,0,0,233,224,255,255,255,255,37,4,160,4,8,104,8,0,0,0,233,208,255,255,255,255,37,8,160,4,8,104,16,0,0,0,233,192,255,255,255,49,237,94,137,225,131,228,240,80,84,82,104,224,131,4,8,104,240,131,4,8,81,86,104,180,131,4,8,232,191,255,255,255,244,144,144,144,144,144,144,144,144,144,144,144,144,144,144,85,137,229,83,131,236,4,128,61,20,160,4,8,0,117,63,161,24,160,4,8,187,32,159,4,8,129,235,28,159,4,8,193,251,2,131,235,1,57,216,115,30,141,182,0,0,0,0,131,192,1,163,24,160,4,8,255,20,133,28,159,4,8,161,24,160,4,8,57,216,114,232,198,5,20,160,4,8,1,131,196,4,91,93,195,141,116,38,0,141,188,39,0,0,0,0,85,137,229,131,236,24,161,36,159,4,8,133,192,116,18,184,0,0,0,0,133,192,116,9,199,4,36,36,159,4,8,255,208,201,195,144,85,137,229,131,228,240,131,236,16,199,4,36,160,132,4,8,232,39,255,255,255,199,4,36,172,132,4,8,232,27,255,255,255,235,254,144,144,144,144,144,144,144,144,144,85,137,229,93,195,141,116,38,0,141,188,39,0,0,0,0,85,137,229,87,86,83,232,79,0,0,0,129,195,249,27,0,0,131,236,28,232,135,254,255,255,141,187,32,255,255,255,141,131,32,255,255,255,41,199,193,255,2,133,255,116,36,49,246,139,69,16,137,68,36,8,139,69,12,137,68,36,4,139,69,8,137,4,36,255,148,179,32,255,255,255,131,198,1,57,254,114,222,131,196,28,91,94,95,93,195,139,28,36,195,144,144,85,137,229,83,131,236,4,161,20,159,4,8,131,248,255,116,19,187,20,159,4,8,102,144,131,235,4,255,208,139,3,131,248,255,117,244,131,196,4,91,93,195,144,144,85,137,229,83,131,236,4,232,0,0,0,0,91,129,195,108,27,0,0,232,156,254,255,255,89,91,201,195,3,0,0,0,1,0,2,0,86,101,114,115,105,111,110,32,50,46,48,0,72,101,108,108,111,32,87,111,114,108,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255,0,0,0,0,255,255,255,255,0,0,0,0,0,0,0,0,1,0,0,0,16,0,0,0,12,0,0,0,144,130,4,8,13,0,0,0,124,132,4,8,245,254,255,111,140,129,4,8,5,0,0,0,252,129,4,8,6,0,0,0,172,129,4,8,10,0,0,0,74,0,0,0,11,0,0,0,16,0,0,0,21,0,0,0,0,0,0,0,3,0,0,0,244,159,4,8,2,0,0,0,24,0,0,0,20,0,0,0,17,0,0,0,23,0,0,0,120,130,4,8,17,0,0,0,112,130,4,8,18,0,0,0,8,0,0,0,19,0,0,0,8,0,0,0,254,255,255,111,80,130,4,8,255,255,255,111,1,0,0,0,240,255,255,111,70,130,4,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40,159,4,8,0,0,0,0,0,0,0,0,214,130,4,8,230,130,4,8,246,130,4,8,0,0,0,0,0,0,0,0,71,67,67,58,32,40,85,98,117,110,116,117,47,76,105,110,97,114,111,32,52,46,52,46,52,45,49,52,117,98,117,110,116,117,53,46,49,41,32,52,46,52,46,53,0,71,67,67,58,32,40,85,98,117,110,116,117,47,76,105,110,97,114,111,32,52,46,52,46,52,45,49,52,117,98,117,110,116,117,53,41,32,52,46,52,46,53,0,0,46,115,121,109,116,97,98,0,46,115,116,114,116,97,98,0,46,115,104,115,116,114,116,97,98,0,46,105,110,116,101,114,112,0,46,110,111,116,101,46,65,66,73,45,116,97,103,0,46,110,111,116,101,46,103,110,117,46,98,117,105,108,100,45,105,100,0,46,103,110,117,46,104,97,115,104,0,46,100,121,110,115,121,109,0,46,100,121,110,115,116,114,0,46,103,110,117,46,118,101,114,115,105,111,110,0,46,103,110,117,46,118,101,114,115,105,111,110,95,114,0,46,114,101,108,46,100,121,110,0,46,114,101,108,46,112,108,116,0,46,105,110,105,116,0,46,116,101,120,116,0,46,102,105,110,105,0,46,114,111,100,97,116,97,0,46,101,104,95,102,114,97,109,101,0,46,99,116,111,114,115,0,46,100,116,111,114,115,0,46,106,99,114,0,46,100,121,110,97,109,105,99,0,46,103,111,116,0,46,103,111,116,46,112,108,116,0,46,100,97,116,97,0,46,98,115,115,0,46,99,111,109,109,101,110,116,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,27,0,0,0,1,0,0,0,2,0,0,0,52,129,4,8,52,1,0,0,19,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,35,0,0,0,7,0,0,0,2,0,0,0,72,129,4,8,72,1,0,0,32,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,49,0,0,0,7,0,0,0,2,0,0,0,104,129,4,8,104,1,0,0,36,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,68,0,0,0,246,255,255,111,2,0,0,0,140,129,4,8,140,1,0,0,32,0,0,0,5,0,0,0,0,0,0,0,4,0,0,0,4,0,0,0,78,0,0,0,11,0,0,0,2,0,0,0,172,129,4,8,172,1,0,0,80,0,0,0,6,0,0,0,1,0,0,0,4,0,0,0,16,0,0,0,86,0,0,0,3,0,0,0,2,0,0,0,252,129,4,8,252,1,0,0,74,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,94,0,0,0,255,255,255,111,2,0,0,0,70,130,4,8,70,2,0,0,10,0,0,0,5,0,0,0,0,0,0,0,2,0,0,0,2,0,0,0,107,0,0,0,254,255,255,111,2,0,0,0,80,130,4,8,80,2,0,0,32,0,0,0,6,0,0,0,1,0,0,0,4,0,0,0,0,0,0,0,122,0,0,0,9,0,0,0,2,0,0,0,112,130,4,8,112,2,0,0,8,0,0,0,5,0,0,0,0,0,0,0,4,0,0,0,8,0,0,0,131,0,0,0,9,0,0,0,2,0,0,0,120,130,4,8,120,2,0,0,24,0,0,0,5,0,0,0,12,0,0,0,4,0,0,0,8,0,0,0,140,0,0,0,1,0,0,0,6,0,0,0,144,130,4,8,144,2,0,0,48,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,135,0,0,0,1,0,0,0,6,0,0,0,192,130,4,8,192,2,0,0,64,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,4,0,0,0,146,0,0,0,1,0,0,0,6,0,0,0,0,131,4,8,0,3,0,0,124,1,0,0,0,0,0,0,0,0,0,0,16,0,0,0,0,0,0,0,152,0,0,0,1,0,0,0,6,0,0,0,124,132,4,8,124,4,0,0,28,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,158,0,0,0,1,0,0,0,2,0,0,0,152,132,4,8,152,4,0,0,32,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,166,0,0,0,1,0,0,0,2,0,0,0,184,132,4,8,184,4,0,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,176,0,0,0,1,0,0,0,3,0,0,0,20,159,4,8,20,15,0,0,8,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,183,0,0,0,1,0,0,0,3,0,0,0,28,159,4,8,28,15,0,0,8,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,190,0,0,0,1,0,0,0,3,0,0,0,36,159,4,8,36,15,0,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,195,0,0,0,6,0,0,0,3,0,0,0,40,159,4,8,40,15,0,0,200,0,0,0,6,0,0,0,0,0,0,0,4,0,0,0,8,0,0,0,204,0,0,0,1,0,0,0,3,0,0,0,240,159,4,8,240,15,0,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,4,0,0,0,209,0,0,0,1,0,0,0,3,0,0,0,244,159,4,8,244,15,0,0,24,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,4,0,0,0,218,0,0,0,1,0,0,0,3,0,0,0,12,160,4,8,12,16,0,0,8,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,224,0,0,0,8,0,0,0,3,0,0,0,20,160,4,8,20,16,0,0,8,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,0,0,229,0,0,0,1,0,0,0,48,0,0,0,0,0,0,0,20,16,0,0,88,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,17,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,108,16,0,0,238,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,228,21,0,0,0,4,0,0,28,0,0,0,44,0,0,0,4,0,0,0,16,0,0,0,9,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,228,25,0,0,250,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,52,129,4,8,0,0,0,0,3,0,1,0,0,0,0,0,72,129,4,8,0,0,0,0,3,0,2,0,0,0,0,0,104,129,4,8,0,0,0,0,3,0,3,0,0,0,0,0,140,129,4,8,0,0,0,0,3,0,4,0,0,0,0,0,172,129,4,8,0,0,0,0,3,0,5,0,0,0,0,0,252,129,4,8,0,0,0,0,3,0,6,0,0,0,0,0,70,130,4,8,0,0,0,0,3,0,7,0,0,0,0,0,80,130,4,8,0,0,0,0,3,0,8,0,0,0,0,0,112,130,4,8,0,0,0,0,3,0,9,0,0,0,0,0,120,130,4,8,0,0,0,0,3,0,10,0,0,0,0,0,144,130,4,8,0,0,0,0,3,0,11,0,0,0,0,0,192,130,4,8,0,0,0,0,3,0,12,0,0,0,0,0,0,131,4,8,0,0,0,0,3,0,13,0,0,0,0,0,124,132,4,8,0,0,0,0,3,0,14,0,0,0,0,0,152,132,4,8,0,0,0,0,3,0,15,0,0,0,0,0,184,132,4,8,0,0,0,0,3,0,16,0,0,0,0,0,20,159,4,8,0,0,0,0,3,0,17,0,0,0,0,0,28,159,4,8,0,0,0,0,3,0,18,0,0,0,0,0,36,159,4,8,0,0,0,0,3,0,19,0,0,0,0,0,40,159,4,8,0,0,0,0,3,0,20,0,0,0,0,0,240,159,4,8,0,0,0,0,3,0,21,0,0,0,0,0,244,159,4,8,0,0,0,0,3,0,22,0,0,0,0,0,12,160,4,8,0,0,0,0,3,0,23,0,0,0,0,0,20,160,4,8,0,0,0,0,3,0,24,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,25,0,1,0,0,0,0,0,0,0,0,0,0,0,4,0,241,255,12,0,0,0,20,159,4,8,0,0,0,0,1,0,17,0,26,0,0,0,28,159,4,8,0,0,0,0,1,0,18,0,40,0,0,0,36,159,4,8,0,0,0,0,1,0,19,0,53,0,0,0,48,131,4,8,0,0,0,0,2,0,13,0,75,0,0,0,20,160,4,8,1,0,0,0,1,0,24,0,90,0,0,0,24,160,4,8,4,0,0,0,1,0,24,0,104,0,0,0,144,131,4,8,0,0,0,0,2,0,13,0,1,0,0,0,0,0,0,0,0,0,0,0,4,0,241,255,116,0,0,0,24,159,4,8,0,0,0,0,1,0,17,0,129,0,0,0,184,132,4,8,0,0,0,0,1,0,16,0,143,0,0,0,36,159,4,8,0,0,0,0,1,0,19,0,155,0,0,0,80,132,4,8,0,0,0,0,2,0,13,0,177,0,0,0,0,0,0,0,0,0,0,0,4,0,241,255,184,0,0,0,244,159,4,8,0,0,0,0,1,0,22,0,206,0,0,0,20,159,4,8,0,0,0,0,0,0,17,0,223,0,0,0,20,159,4,8,0,0,0,0,0,0,17,0,242,0,0,0,40,159,4,8,0,0,0,0,1,0,20,0,251,0,0,0,12,160,4,8,0,0,0,0,32,0,23,0,6,1,0,0,224,131,4,8,5,0,0,0,18,0,13,0,22,1,0,0,0,131,4,8,0,0,0,0,18,0,13,0,29,1,0,0,0,0,0,0,0,0,0,0,32,0,0,0,44,1,0,0,0,0,0,0,0,0,0,0,32,0,0,0,64,1,0,0,152,132,4,8,4,0,0,0,17,0,15,0,71,1,0,0,124,132,4,8,0,0,0,0,18,0,14,0,77,1,0,0,0,0,0,0,0,0,0,0,18,0,0,0,106,1,0,0,156,132,4,8,4,0,0,0,17,0,15,0,121,1,0,0,12,160,4,8,0,0,0,0,16,0,23,0,134,1,0,0,16,160,4,8,0,0,0,0,17,2,23,0,147,1,0,0,32,159,4,8,0,0,0,0,17,2,18,0,160,1,0,0,240,131,4,8,90,0,0,0,18,0,13,0,176,1,0,0,20,160,4,8,0,0,0,0,16,0,241,255,188,1,0,0,28,160,4,8,0,0,0,0,16,0,241,255,193,1,0,0,0,0,0,0,0,0,0,0,18,0,0,0,209,1,0,0,20,160,4,8,0,0,0,0,16,0,241,255,216,1,0,0,74,132,4,8,0,0,0,0,18,2,13,0,239,1,0,0,180,131,4,8,35,0,0,0,18,0,13,0,244,1,0,0,144,130,4,8,0,0,0,0,18,0,11,0,0,99,114,116,115,116,117,102,102,46,99,0,95,95,67,84,79,82,95,76,73,83,84,95,95,0,95,95,68,84,79,82,95,76,73,83,84,95,95,0,95,95,74,67,82,95,76,73,83,84,95,95,0,95,95,100,111,95,103,108,111,98,97,108,95,100,116,111,114,115,95,97,117,120,0,99,111,109,112,108,101,116,101,100,46,55,48,54,53,0,100,116,111,114,95,105,100,120,46,55,48,54,55,0,102,114,97,109,101,95,100,117,109,109,121,0,95,95,67,84,79,82,95,69,78,68,95,95,0,95,95,70,82,65,77,69,95,69,78,68,95,95,0,95,95,74,67,82,95,69,78,68,95,95,0,95,95,100,111,95,103,108,111,98,97,108,95,99,116,111,114,115,95,97,117,120,0,97,112,112,50,46,99,0,95,71,76,79,66,65,76,95,79,70,70,83,69,84,95,84,65,66,76,69,95,0,95,95,105,110,105,116,95,97,114,114,97,121,95,101,110,100,0,95,95,105,110,105,116,95,97,114,114,97,121,95,115,116,97,114,116,0,95,68,89,78,65,77,73,67,0,100,97,116,97,95,115,116,97,114,116,0,95,95,108,105,98,99,95,99,115,117,95,102,105,110,105,0,95,115,116,97,114,116,0,95,95,103,109,111,110,95,115,116,97,114,116,95,95,0,95,74,118,95,82,101,103,105,115,116,101,114,67,108,97,115,115,101,115,0,95,102,112,95,104,119,0,95,102,105,110,105,0,95,95,108,105,98,99,95,115,116,97,114,116,95,109,97,105,110,64,64,71,76,73,66,67,95,50,46,48,0,95,73,79,95,115,116,100,105,110,95,117,115,101,100,0,95,95,100,97,116,97,95,115,116,97,114,116,0,95,95,100,115,111,95,104,97,110,100,108,101,0,95,95,68,84,79,82,95,69,78,68,95,95,0,95,95,108,105,98,99,95,99,115,117,95,105,110,105,116,0,95,95,98,115,115,95,115,116,97,114,116,0,95,101,110,100,0,112,117,116,115,64,64,71,76,73,66,67,95,50,46,48,0,95,101,100,97,116,97,0,95,95,105,54,56,54,46,103,101,116,95,112,99,95,116,104,117,110,107,46,98,120,0,109,97,105,110,0,95,105,110,105,116,0};
    crc expected_checksum = 0xaa47;
    size_t size = 7134;

    pid_t pid = get_app_pid("app1");
    while (pid > 0) {
        kill(pid, SIGKILL);
        printf("Killing process pid = %d\n", pid);
        pid = get_app_pid("app1");
    }

    if (rename_app("./apps/", "app1", "old-app1", 10) == 1) {
        printf("Renaming app failed\n");
        return 1;
    }

    if (write_app("./apps/", "app1", bin, size) == 1) {
        printf("Writing app failed\n");
        return 1;
    }

    crc actual_checksum = get_app_checksum("./apps/", "app1");
    if (actual_checksum != expected_checksum) {
        printf("Checksum does not match. Actual = 0x%x, Expected = 0x%x\n", actual_checksum, expected_checksum);
        return 1;
    }
    
    remove("./apps/old-app1");

    return 0;
}


crc get_app_checksum(const char* path, const char* name) {
    char filename[50];
    strcpy(filename, path);
    strcat(filename, name);

    crc result = 0;

    FILE* fp;
    fp = fopen(filename, "rb");
 
    //Get program size
    fseek(fp, 0, SEEK_END);
    unsigned long size = ftell(fp);
    rewind(fp);

    unsigned char* program = (unsigned char*) malloc (sizeof(unsigned char) * size);
    unsigned long read = fread(program, 1, size, fp); //Test if this can fail

    crcInit();
    if (read == size) {
        result = crcFast(program, size);
    }

    free(program); 
    fclose(fp);

    return result;
}

pid_t get_app_pid(const char* name) {
    pid_t result = -1;
    char command[12] = "pidof ";
    strcat(command, name);

    FILE* fp;
    fp = popen(command, "r");
    if (fp == NULL) {
        return result;
    }

    char pid[10] = "";
    fgets(pid, sizeof(pid) - 1, fp);
    if (strcmp(pid, "") != 0 && pid != NULL) {
        result = atoi(pid); //pid can contain many pids separated by a space, atoi grabs the first one
    }
    
    fflush(fp);
    pclose(fp);
    
    return result;
}

int rename_app(const char* path, const char* current_name, const char* new_name, int retries) {
    char current[50];
    char new[50];

    strcpy(current, path);
    strcat(current, current_name);

    strcpy(new, path);
    strcat(new, new_name);

    do {
        retries--;
        if (rename(current, new) == 0) {
            return 0;
        }
    } while (retries > 0);

    return 1;
}

int write_app(const char* path, const char* name, const char* binary, size_t size) {
    char filename[50];
    strcpy(filename, path);
    strcat(filename, name);

    FILE *fp;
    fp = fopen(filename, "wb");

    //To do: tests if this can fail
    fwrite(binary, sizeof(unsigned char), size, fp);

    fclose(fp);

    chmod(filename, S_IRWXU);
    return 0;
}
